#!/bin/bash

# Check for root
[[ $EUID -ne 0 ]] && echo "Error: Run as root." && exit 1

CONF="/etc/nftables.conf"
PROTO=${3:-tcp} # Default to tcp if not specified

case "$1" in
    allow)
        # Open a port and save
        nft add element inet filter allowed_${PROTO} { $2 }
        nft list ruleset > "$CONF"
        echo "Port $2 ($PROTO) opened."
        ;;
        
    deny)
        # Close a port and save
        nft delete element inet filter allowed_${PROTO} { $2 } 2>/dev/null
        nft list table inet filter > "$CONF"
        echo "Port $2 ($PROTO) closed."
        ;;
        
    panic)
        # Close ALL open ports (Clear the lists)
        echo "Closing all open ports..."
        nft flush set inet filter allowed_tcp
        nft flush set inet filter allowed_udp
        nft list table inet filter > "$CONF"
        echo "Done. System is isolated (default policies apply)."
        ;;
        
    reload)
        # Reload from config file
        nft -f "$CONF" && echo "Rules reloaded from $CONF."
        ;;
        
    list)
        # Simple status check
        echo "--- Open TCP ---"
        nft list set inet filter allowed_tcp
        echo "--- Open UDP ---"
        nft list set inet filter allowed_udp
        ;;
        
    *)
        echo "Usage: $0 {allow|deny} <port> [tcp|udp]"
        echo "       $0 {panic|reload|list}"
        exit 1
        ;;
esac
