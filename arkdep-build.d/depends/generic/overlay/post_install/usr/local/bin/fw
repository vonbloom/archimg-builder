#!/usr/bin/bash

[[ $EUID -ne 0 ]] && echo "Error: Run as root." && exit 1

RULES="/etc/iptables/iptables.rules"

save() {
    echo "Saving to $RULES..."
    iptables-save -f "$RULES"
}

case "$1" in
allow)
    [[ -z "$2" ]] && echo "Usage: fw allow <port> [tcp|udp]" && exit 1
    PROTO=${3:-tcp}
    PROTO=${PROTO,,}
    iptables -C INPUT -p "$PROTO" --dport "$2" -j ACCEPT 2>/dev/null || {
        iptables -I INPUT -p "$PROTO" --dport "$2" -j ACCEPT && save
    }
    ;;
deny)
    [[ -z "$2" ]] && echo "Usage: fw deny <port> [tcp|udp]" && exit 1
    PROTO=${3:-tcp}
    PROTO=${PROTO,,}
    iptables -D INPUT -p "$PROTO" --dport "$2" -j ACCEPT 2>/dev/null && save
    ;;
panic)
    echo "EMERGENCY: Closing all incoming ports..."
    echo "Note: These changes are NOT saved and will be lost on reboot."
    iptables -P INPUT DROP
    iptables -F INPUT
    iptables -A INPUT -i lo -j ACCEPT
    iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
    ;;
reload)
    echo "Reloading base configuration..."
    iptables-restore <"$RULES" && echo "Done."
    ;;
*)
    echo "Usage: $0 {allow|deny|panic|reload} <port> [tcp|udp]"
    exit 1
    ;;
esac
